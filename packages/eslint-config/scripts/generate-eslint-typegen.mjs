import fs from 'node:fs/promises';
import path from 'node:path';

import eslintReact from '@eslint-react/eslint-plugin';
import eslintComments from '@eslint-community/eslint-plugin-eslint-comments';
import nextPlugin from '@next/eslint-plugin-next';
import { pluginsToRulesDTS } from 'eslint-typegen/core';
import { importX } from 'eslint-plugin-import-x';
import jsxA11y from 'eslint-plugin-jsx-a11y';
import perfectionistPlugin from 'eslint-plugin-perfectionist';
import reactCompiler from 'eslint-plugin-react-compiler';
import reactHooksPlugin from 'eslint-plugin-react-hooks';
import reactNativePlugin from 'eslint-plugin-react-native';
import reactPlugin from 'eslint-plugin-react';
import reactRefresh from 'eslint-plugin-react-refresh';
import regexpPlugin from 'eslint-plugin-regexp';
import simpleImportSort from 'eslint-plugin-simple-import-sort';
import unicornPlugin from 'eslint-plugin-unicorn';
import unusedImportsPlugin from 'eslint-plugin-unused-imports';
import tseslint from 'typescript-eslint';

const outFile = path.resolve('src/eslint-typegen.d.ts');

const eslintReactPlugins = eslintReact.configs['recommended-typescript']?.plugins ?? {};

const dts = await pluginsToRulesDTS({
  // ESLint plugins used by this package
  '@typescript-eslint': tseslint.plugin,
  unicorn: unicornPlugin,
  'import-x': importX,
  'simple-import-sort': simpleImportSort,
  perfectionist: perfectionistPlugin,
  react: reactPlugin,
  'react-hooks': reactHooksPlugin,
  'react-refresh': reactRefresh,
  'react-native': reactNativePlugin,
  regexp: regexpPlugin,
  'unused-imports': unusedImportsPlugin,
  'jsx-a11y': jsxA11y,
  '@next/next': nextPlugin,
  '@eslint-community/eslint-comments': eslintComments,

  // @eslint-react registers multiple plugin namespaces
  '@eslint-react': eslintReactPlugins['@eslint-react'],
  '@eslint-react/dom': eslintReactPlugins['@eslint-react/dom'],
  '@eslint-react/web-api': eslintReactPlugins['@eslint-react/web-api'],
  '@eslint-react/hooks-extra': eslintReactPlugins['@eslint-react/hooks-extra'],
  '@eslint-react/naming-convention': eslintReactPlugins['@eslint-react/naming-convention'],
});

const banner = `// This file is generated by scripts/generate-eslint-typegen.mjs\n// Do not edit manually.\n\n`;

await fs.mkdir(path.dirname(outFile), { recursive: true });
await fs.writeFile(outFile, banner + dts, 'utf8');
